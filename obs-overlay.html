<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>JodiFy OBS Overlay</title>
  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }
    html, body { margin:0; width:100%; height:100%; background: transparent; overflow: hidden; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; }

    .overlay {
      position: fixed;
      left: 26px;
      bottom: 22px;
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 12px 14px;
      border-radius: 16px;
      background: rgba(8, 10, 18, 0.72);
      border: 1px solid rgba(255,255,255,0.14);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      min-width: 340px;
      max-width: 540px;
      box-shadow: 0 16px 34px rgba(0,0,0,0.35);
    }

    .cover { width: 58px; height: 58px; border-radius: 12px; object-fit: cover; border: 1px solid rgba(255,255,255,0.16); }
    .meta { flex: 1; min-width: 0; }
    .title { color: #fff; font-size: 16px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .subtitle { color: rgba(255,255,255,0.75); font-size: 12px; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .bar {
      margin-top: 8px;
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: rgba(255,255,255,0.18);
      overflow: hidden;
    }
    .fill {
      width: 0%;
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(90deg, #8b5cf6, #22d3ee);
      transition: width .25s linear;
    }
    .badge {
      min-width: 72px;
      text-align: center;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: .06em;
      text-transform: uppercase;
      color: #fff;
      border-radius: 999px;
      padding: 8px 10px;
      background: rgba(255,255,255,0.14);
      border: 1px solid rgba(255,255,255,0.2);
    }

    .paused .badge { background: rgba(255, 184, 0, 0.2); }

    @media (max-width: 640px) {
      .overlay {
        left: 10px;
        right: 10px;
        bottom: 10px;
        min-width: 0;
        max-width: none;
        padding: 10px;
        gap: 10px;
      }

      .cover {
        width: 46px;
        height: 46px;
      }

      .title {
        font-size: 13px;
      }

      .subtitle {
        font-size: 11px;
      }

      .badge {
        min-width: 62px;
        font-size: 10px;
        padding: 6px 8px;
      }
    }
  </style>
</head>
<body>
  <div class="overlay paused" id="overlayRoot">
    <img id="cover" class="cover" src="assets/default-cover.png" alt="cover" />
    <div class="meta">
      <div id="title" class="title">Sin reproducción</div>
      <div id="subtitle" class="subtitle">JodiFy</div>
      <div class="bar"><div id="progress" class="fill"></div></div>
    </div>
    <div id="status" class="badge">PAUSADO</div>
  </div>

  <script>
    const titleEl = document.getElementById('title');
    const subtitleEl = document.getElementById('subtitle');
    const coverEl = document.getElementById('cover');
    const progressEl = document.getElementById('progress');
    const statusEl = document.getElementById('status');
    const rootEl = document.getElementById('overlayRoot');

    const SB_URL = 'https://wgwafnndqhqlmwvrgiqt.supabase.co';
    const SB_KEY = 'sb_publishable_lIo5RKzxB7pVAHdBx5aejQ_IeooCEj1';
    const qs = new URLSearchParams(location.search);
    const overlayUsername = qs.get('u');

    function applyState(state) {
      if (!state) return;
      titleEl.textContent = state.title || 'Sin reproducción';
      subtitleEl.textContent = state.addedBy ? `Por ${state.addedBy}` : 'JodiFy';
      if (state.cover) coverEl.src = state.cover;
      const pct = state.duration > 0 ? Math.min(100, Math.max(0, (state.currentTime / state.duration) * 100)) : 0;
      progressEl.style.width = `${pct}%`;
      const playing = !!state.isPlaying;
      statusEl.textContent = playing ? 'EN VIVO' : 'PAUSADO';
      rootEl.classList.toggle('paused', !playing);
    }

    function readState() {
      try {
        const raw = localStorage.getItem('jodify_obs_overlay_state');
        if (!raw) return;
        applyState(JSON.parse(raw));
      } catch {}
    }

    async function readRemoteState() {
      if (!overlayUsername) {
        readState();
        return;
      }
      try {
        const url = `${SB_URL}/rest/v1/users_access?select=current_song_name,listening_since,username&username=eq.${encodeURIComponent(overlayUsername)}&limit=1`;
        const res = await fetch(url, {
          headers: {
            apikey: SB_KEY,
            Authorization: `Bearer ${SB_KEY}`
          }
        });
        const rows = await res.json();
        const row = Array.isArray(rows) ? rows[0] : null;
        const title = row?.current_song_name || 'Sin reproducción';
        applyState({
          title,
          addedBy: row?.username || overlayUsername,
          cover: 'assets/default-cover.png',
          currentTime: 0,
          duration: 0,
          isPlaying: Boolean(row?.current_song_name)
        });
      } catch (e) {
        readState();
      }
    }

    window.addEventListener('storage', (e) => {
      if (e.key === 'jodify_obs_overlay_state' && e.newValue) {
        try { applyState(JSON.parse(e.newValue)); } catch {}
      }
    });

    readRemoteState();
    setInterval(readRemoteState, 2000);
  </script>
</body>
</html>
